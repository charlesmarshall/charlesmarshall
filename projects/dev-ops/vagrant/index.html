<!doctype html>
<html lang="en" id="projects">
  <head>
<!--[if IE]>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
<![endif]-->

<!--[if lte IE 8]>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
<style>
         .chromeFrameInstallDefaultStyle {
           width: 800px;
           border: 2px solid #222;
           z-index: 99999;
         }
        </style>

        <script>
         // The conditional ensures that this code will only execute in IE,
         // Therefore we can use the IE-specific attachEvent without worry
         window.attachEvent("onload", function() {
            if(typeof(chromeframe_disable) == "undefined") {
               CFInstall.check({
                 mode: "inline", // the default
                 oninstall: function(){
                    alert("Chrome Frame is now installed. You may need to restart your browser.");
                 }
               });
            }
         });

        </script>
<![endif]-->

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,400,300,600,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=News+Cycle:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/stylesheets/build.css" type="text/css" media="all" charset="utf-8" >

    <title>Vagrant  - DevOps - Projects & Websites - Charles Marshall</title>
  </head>
  <body id="droplet">

    <header id="header">
      <nav id="navigation" class='clearfix'>
        <a href="/" class='home'>Home</a>
        <a href="/demos/" class='demos'>Demos</a>
        <a href="/projects/" class='projects'>Projects</a>
      </nav>
    </header>

     <section id="intro">
      <h1>Vagrant</h1>
      <h4 class='date'>04<sup>th</sup> May 2014</h4>

      <p>We've had source control tools to handle code bases for many years now; from CVS, to subversion and now the DVCS generation (we use Git). However, code is only part of the system, we still rely on a predictable host to run smoothy and if you try running your cutting-edge application on an out-of-date setup, it's not going to play ball.</p>
      <p>As a development team grows and the code base increases in complexity, the exact setup becomes harder to replicate and this problem becomes more pronounced the more you scale. When you then consider mirroring these setups between localised dev, staging and production environments and factor in multiple platforms, it's time to start automating the consistency you need. Solving this problem is the goal of quite a few projects, but as we're using CoreOS it makes sense to use the pre-built images for <a href="http://vagrantup.com">Vagrant</a>.</p>
      <p>Vagrant uses configuration files to run commands on top of a virtualised environment; generally either Virtualbox or VM Ware, but now supports Docker as well. As we have a mix of operating systems and an expanding team, we chose to go with Virtualbox, as it supports all the platforms we use and is open source.</p>
      <p>On Ubuntu you can install via the software centre by just searching for it by name; alternatively, you can follow the methods outlined on the <a href="https://www.virtualbox.org/wiki/Linux_Downloads">Linux setup guide</a>. If you are running on OS X, just grab the correct DMG from the <a href="https://www.virtualbox.org/wiki/Downloads">download list</a> and install as normal.</p>
      <p>Once you have that up and running (give it a test if you have an ISO handy) then its time to move on to getting Vagrant downloaded. Again, there are simple <a href="http://www.vagrantup.com/downloads">install options</a> provided by the vendor on their website. This can take a while and does change, so I'd recommend checking out a guide if you're new to using Vagrant. After that is ready, then it's time to create your environment.</p>

      <h3>Making your own</h3>
      <p>CoreOS provide a <a href="https://coreos.com/docs/running-coreos/platforms/vagrant/">basic guide</a> to get up and running that should you definitely have a read through first, but we'll make some changes.</p>
      <p>Create a directory and initialise Git:</p>
      <pre>
mkdir /path/to/dev-env/
cd /path/to/dev-env/
git init .
      </pre>
      <p>At this point, lets make the files we need and explain what they are and do.</p>
      <pre>touch ./override-plugin.rb
      </pre>
      <p>This is included by the Vagrantfile, and for our purposes sets various values ready for CoreOS to run locally. As this tends to change, here is a <a href="https://gist.github.com/charlesmarshall/212313def44c1b903b61">gist with the exact version we run</a>.</p>
      <pre>touch ./Vagrantfile
      </pre>
      <p>This is the main file and should be based on the provided version from <a href="https://github.com/coreos/coreos-vagrant/blob/master/Vagrantfile">CoreOS</a>. If you know your way around Vagrant, feel free to amend or roll your own; thats what we did and <a href="https://gist.github.com/charlesmarshall/73a75a0bbd781011e9d4">here is our gist</a>. Ours has a few differences that I'll go over.</p>
      <p>We set <code>NUM_INSTANCES</code> within the Vagrantfile itself, rather than including another file, and default it to 3, for a basic cluster. <a href="https://gist.github.com/charlesmarshall/73a75a0bbd781011e9d4#file-vagrantfile-L6">Line #6</a></p>
      <p>We've included the ability to load different provisioning scripts between the first core and others. These allow you to run some code on the first <code>sudo Vagrant up</code>, this can be handy to set basic environment switches, like declaring that you are in development mode for example. <a href="https://gist.github.com/charlesmarshall/73a75a0bbd781011e9d4#file-vagrantfile-L36-L40">Line #36-40</a></p>
      <pre>touch ./provision.sh
touch ./provision-slave.sh
      </pre>
      <p>These bash scripts allow you to run arbitrary commands, however as these would only be run via Vagrant they are not suitable for production code, instead you should use the user-data config file for consistency between production and development.</p>
      <pre>touch ./user-data
      </pre>
      <p>This where most of your customisation comes in, by editing your cloud-config file. This format is supported (<a href="http://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/">in part</a>) by CoreOs as well as several cloud hosting providers, including AWS, Open Stack and others.</p>
      <p>Unlike the provisioning scripts (mentioned above) these are run on creation and allow writing of files (such as bootstrap scripts), adding SSH keys and more. The <a href="https://github.com/coreos/coreos-vagrant/blob/4c1fb7d4edc0ac9fdec4dde0e61f7bb7e84fd735/user-data.sample">example file</a> provided by CoreOs will be enough to get you started. You'll need to uncomment <a href="https://github.com/coreos/coreos-vagrant/blob/4c1fb7d4edc0ac9fdec4dde0e61f7bb7e84fd735/user-data.sample#L6">line #6</a> and replace the <code>&lt;token&gt;</code> with the value generated by visiting https://discovery.etcd.io/new. This is the discovery URL used to find all other host machines in your cluster.</p>
      <p>Note: When you destroy a Vagrant cluster you will need a new <code>&lt;token&gt;</code>.</p>

      <h3>Running the CoreOS cluster</h3>
      <p>Now you should have a set of files you can use to turn on a machine. Although the first setup like this can be time consuming, once it's done and saved to your git repo you can distrubte to everyone easily and running the environment is simple.</p>
      <code>sudo vagrant up</code>
      <p>That will now setup your VM and get everything running. The first time it can be slow, as it has to download the base box, which is currently ~175mb, so you might want to go make a cup of tea.</p>
      <p>This setup might fail if the connection times out or if other errors are encountered, Vagrant has been around for a while, so Google is your friend if this happens. Don't worry, one of the nice parts of virtualisation is it is easy to remove and does no long term damage to your own environment. To start from scratch, just destroy things:</p>
      <code>sudo vagrant destroy</code>
      <p>Once the up has completed, check to see whats running:</p>
      <code>sudo vagrant status</code>
      <p>You should get 3 hosts in the list, each one can be connected to via SSH, just run:</p>
      <code>sudo vagrant ssh core-N</code>
      <p>Where N is one of the host numbers, I would start with 01, as thats the primary host in this case.</p>
      <h3>Bootstrapping your host</h3>
      <p>When you have connected you'll need to change some settings. As CoreOs is still in alpha it runs <a href="https://github.com/Netflix/SimianArmy/wiki/Chaos-Monkey">Chaos Monkey</a>, which will randomly turn off hosts, great for testing cluster stability, not so good when you are trying to test your own code on top of it. Lets turn it off:</p>
      <pre>sudo systemctl stop update-engine-reboot-manager.service
sudo systemctl mask update-engine-reboot-manager.service
</pre>
      <p>You might very well notice some network speed issues and dropped packages; there can be an issue with the local Vagrant setup that puts a 10.x.x.x series ip address as the nameserver and regenerates it via a systemd unit. Simply remove the symlink /etc/resolv.conf and replace with Google's (or your own):</p>
      <pre>sudo mv /etc/resolv.conf /etc/resolv.old.conf
sudo touch /etc/resolv.conf
sudo chmod 0777 /etc/resolv.conf
sudo echo "nameserver 8.8.8.8" > /etc/resolv.conf
      </pre>
      <p>These are ideal to be placed into a bootstrap file generated by your user-data config.</p>
      <h3>Checking your cluster</h3>
      <p>Let's make sure everything is responding correctly and the etcd discovery worked, otherwise non of our fun things with Docker will work properly.</p>
      <pre>fleetctl list-machines
      </pre>
      <p>This should list all the machines in your cluster (3 in this case), their machine ID and IP address.</p>
      <pre>etcdctl ls --recursive
      </pre>
      <p>On a new cluster, this will be empty, but if you have a problem then this will either timeout or return a sync error. If they fail, you'll need to destroy and start again.</p>
      <p>If you are finished, or need to shutdown your machine, you can simply turn off the virtual machines from a terminal window by running:</p>
      <pre>sudo vagrant halt
      </pre>
      <p>That's a basic cluster, running, starting, stopping, but it doesn't do a huge amount automatically yet. In the part of our series, we'll go over changing user-data to make it more exciting.</p>
    </section>




    <script src='http://www.google.com/jsapi?'  type='text/javascript'></script>
    <script type="text/javascript">google.load('jquery', '1.7');</script>
    <script src='/javascripts/fancybox.js' type='text/javascript'></script>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-927511-5']);
    _gaq.push(['_setDomainName', 'charlesmarshall.co.uk']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</body>
</html>