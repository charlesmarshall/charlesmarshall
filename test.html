<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <script src='http://www.google.com/jsapi'  type='text/javascript'></script>
  <script type='text/javascript'>
    //google load
    google.load('jquery', '1.3');
    google.load('maps', '2', {"other_params":"sensor=true"});
    google.load('search', '1');
  </script>
  <link rel="stylesheet" href="stylesheets/styles.css" type="text/css" media="screen" title="no title" charset="utf-8"/>
  <style>
  #map_street_view{
    width:845px;
    margin:auto;
  }
  #gmap{
    width:845px;
    height:350px;
  }
  #gstreetview{
    width:845px;
    height:350px;
    display:none;
  }
  #sv_control{
    padding:5px;
    cursor:pointer;
    margin-top:267px;
    margin-left:11px;
    height:1px;
    width:1px;
  }
  .clone{border:1px solid red;display:none;}
  </style>
</head>
<body onload="initialize()" onunload="GUnload()">
  <div class='example' id="map_street_view">
    <div id="gmap" class='gmap'></div>
    <div id="sv_control"><div id="sv_ui" title='click to trigger street view'><div id="sv_text"></div></div></div>
    <div id="gstreetview" class='streetview'></div>
  </div>
  <script type='text/javascript'>
    var MAP=false;
    //OBJ
    function SVC(svdiv, pano, map, run_init, start_postion){
      var control = this;
      this._svclient = new GStreetviewClient();
      this._map = map;
      this._pano = new GStreetviewPanorama(pano);
      this._pano_container = pano;
      this._container = svdiv;
      this._controlUI = jQuery('#sv_ui')[0];
      this._controlText = jQuery('#sv_text')[0];
      this._overlay = new GStreetviewOverlay();
      if(typeof start_position != "undefined") this._position = start_position;
      if(typeof run_init != "undefined" && run_init) this.initialize();
    };
    SVC.prototype = new GControl();
    SVC.prototype.initialize = function(map){
      var control = this;
      this._map = map;
      this._control_left = 39,
      this._control_top = parseInt(jQuery(this._controlText).position().top - jQuery(this._container).position().top),
      this.place_man();
      GEvent.addListener(this._map, "move", function(){
        control.place_man();
      });
      this._click_trigger = this._controlText;
      this._map.getContainer().appendChild(this._container);
      this.enableDraggableControl();
      return this._container;
    };
    SVC.prototype.place_man = function(){
      var control = this,
          jqmap = jQuery(this._map.getContainer()),
          micon = this.man_icon(),
          bb = this._map.getBounds(),
          px_left = this._control_left,
          px_top = this._control_top+(micon.iconSize.height*2),
          px_point = new GPoint(px_left, px_top);
          px_latlng = this._map.fromContainerPixelToLatLng(px_point);
          ;
      this._man_position = px_latlng;
      if(this._man_marker == null){
        this._man_marker = new GMarker(this._man_position, {icon:micon, title:'street view', draggable:true});
        this._map.addOverlay(this._man_marker);
      }else this._man_marker.setLatLng(this._man_position);

    };
    SVC.prototype.man_icon = function(){
      var guy = new GIcon(G_DEFAULT_ICON);
      guy.image = "images/street-view.png";
      guy.transparent = false;
      guy.shadow = false;
      guy.shadowSize = new GSize(false,false);
      guy.iconSize = new GSize(13, 24);
      return guy;
    };

    SVC.prototype.addSVOverlay = function(){
      this._map.addOverlay(this._overlay);
      this._layer_enabled = true;
    };
    SVC.prototype.removeSVOverlay = function(){
      this._map.removeOverlay(this._overlay);
      this._layer_enabled = false;
    };
    SVC.prototype.dragError = function(){
      this.removeSVOverlay();
      this.place_man();
      return;
    };
    SVC.prototype.enableDraggableControl = function(){
      var control = this;
      GEvent.addListener(this._man_marker, 'dragstart', function(){
        control.removeSVOverlay();
        control.addSVOverlay();
      });

      GEvent.addListener(this._pano, "error", function(){
        return control.dragError();
      });


      GEvent.addListener(this._man_marker, 'dragend', function(){
        var ll = control._man_marker.getLatLng();
        control._svclient.getNearestPanorama(ll,function(res){
          if(res.code == 200){
            control._pano.setLocationAndPOV(res.location.latlng);
            var justonce = GEvent.addListener(control._pano, "initialized", function(){
              console.log("started");
              control.street_view_started();
              GEvent.removeListener(justonce);
            });
            jQuery(control._pano_container).show().css('margin-top', "-"+jQuery(control._map.getContainer()).outerHeight()+'px');
          }else{
            return control.dragError();
          }
        });
      });

    };
    SVC.prototype.street_view_started = function(){
      var p = jQuery("param[name='flashvars']"),
          fvars = p.attr('value').replace("context=api", "content=maps_sv")
          ;
      p.attr('value', fvars);
      p.parent().attr('data',p.parent().attr('data').replace("googlepano.112.swf", "googlepano.121.swf") );
      console.log(jQuery(this._pano_container));
    };
    SVC.prototype.getDefaultPosition = function() {
      return new GControlPosition(G_ANCHOR_TOP_LEFT, new GSize(14, 7));
    };

    SVC.prototype._svclient = null;
    SVC.prototype._map = null;
    SVC.prototype._pano = null;
    SVC.prototype._pano_container = null;
    SVC.prototype._man_marker = null;
    SVC.prototype._click_trigger = null;
    SVC.prototype._container = null;
    SVC.prototype._position = null;
    SVC.prototype._controlUI = null;
    SVC.prototype._controlText = null
    SVC.prototype._layer_enabled = false;
    SVC.prototype._overlay = null;
    SVC.prototype._drag = null;
    SVC.prototype._drag_start = null;
    SVC.prototype._drag_end = null;


    //INIT
    function initialize() {
      var latlng = new google.maps.LatLng(52.502625,-1.893997),
          opts = {zoom: 12, center: latlng},
          customcontroldiv = jQuery('#sv_control')[0],
          sview = jQuery('#gstreetview')[0],
          customcontrol = new SVC(customcontroldiv, sview, MAP);
          ;
      customcontroldiv.index = 0;
      //v3 - MAP = new google.maps.Map(document.getElementById("gmap"), opts);
      //v2
      MAP = new GMap2(document.getElementById("gmap"));
      MAP.setCenter(opts.center, opts.zoom);
      MAP.setUIToDefault();
      //v3 - MAP.controls[google.maps.ControlPosition.LEFT].push(customcontroldiv);
      //v2
      MAP.addControl(customcontrol);

    }


  </script>
</body>
</html>
